<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trip Helper</title>
    <meta name="theme-color" content="#000">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logo.png">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; background: #000; color: #e5e7eb; min-height: 100dvh; }
        
        .container { max-width: 480px; margin: 0 auto; padding: 1rem; }
        
        /* Buttons & Inputs */
        button { cursor: pointer; border: none; font: inherit; }
        .btn { padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 600; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-sm { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
        .btn-ghost { background: rgba(255,255,255,0.05); color: #9ca3af; }
        .btn-danger { background: transparent; color: #ef4444; }
        
        input, select { width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; color: white; outline: none; font: inherit; }
        input:focus { border-color: #3b82f6; }
        input::placeholder { color: #6b7280; }
        
        /* Cards */
        .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; }
        .card-header { font-size: 0.75rem; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin-bottom: 0.5rem; }
        
        /* Badges */
        .badge { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: rgba(255,255,255,0.05); border-radius: 0.375rem; font-size: 0.75rem; }
        
        /* Modal */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 50; }
        .modal { background: #1f2937; border-radius: 0.75rem; padding: 1.5rem; width: 100%; max-width: 20rem; }
        .modal h2 { text-align: center; margin-bottom: 1rem; }
        
        /* Tabs */
        .tabs { display: flex; gap: 0.25rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem; padding: 0.25rem; margin-bottom: 1rem; }
        .tab { flex: 1; padding: 0.5rem; text-align: center; font-size: 0.875rem; font-weight: 600; color: #6b7280; border-radius: 0.375rem; background: transparent; }
        .tab.active { background: rgba(255,255,255,0.1); color: white; }
        
        /* Calendar */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
        .cal-day { aspect-ratio: 1; border-radius: 0.375rem; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; background: rgba(255,255,255,0.05); color: #6b7280; cursor: pointer; border: 1px solid transparent; }
        .cal-day:hover { background: rgba(255,255,255,0.1); }
        .cal-day.mine { background: rgba(34,197,94,0.2); border-color: #22c55e; color: #4ade80; }
        .cal-day.others { background: rgba(59,130,246,0.2); border-color: #3b82f6; color: #60a5fa; }
        .cal-day.best { background: #fbbf24 !important; color: #000 !important; font-weight: 700; }
        .cal-day.past { opacity: 0.3; pointer-events: none; }
        .cal-day.header { background: transparent; font-weight: 700; cursor: default; }
        
        /* List items */
        .list-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem; margin-bottom: 0.5rem; }
        .list-item:hover { background: rgba(255,255,255,0.08); }
        
        /* Flex helpers */
        .flex { display: flex; }
        .flex-1 { flex: 1; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-muted { color: #6b7280; }
        .font-bold { font-weight: 700; }
        .hidden { display: none !important; }
        
        /* Header */
        header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-size: 1.125rem; }
        
        /* Finalized banner */
        .banner { background: rgba(251,191,36,0.1); border: 1px solid #fbbf24; border-radius: 0.5rem; padding: 0.5rem 0.75rem; margin-bottom: 1rem; font-size: 0.875rem; color: #fbbf24; }
        
        /* Vote card */
        .vote-card { border-left: 3px solid transparent; }
        .vote-card.voted { border-left-color: #3b82f6; }
        
        /* Suggestions dropdown */
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #1f2937; border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; margin-top: 0.25rem; max-height: 200px; overflow-y: auto; z-index: 10; }
        .suggestion { padding: 0.75rem; cursor: pointer; }
        .suggestion:hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp({
            apiKey: "AIzaSyDGrq3qdR3pqHc0dQMXnE20c2wcLOINN-8",
            authDomain: "rendercode-d73da.firebaseapp.com",
            projectId: "rendercode-d73da",
            storageBucket: "rendercode-d73da.firebasestorage.app",
            messagingSenderId: "798989930424",
            appId: "1:798989930424:web:7f324e5153cabc5d90494d"
        });
        const db = getFirestore(app);

        // State
        let tripId = new URLSearchParams(location.search).get('token');
        let user = { id: null, name: localStorage.getItem('trip_user_name') };
        let data = { users: {}, locations: [], packing: [], itinerary: {} };
        let tab = 'plan';
        let calMonth = new Date();
        let unsubscribe = null;

        const $ = (id) => document.getElementById(id);

        // Firebase
        const sync = () => setDoc(doc(db, 'trip-planner-v1', tripId), data, { merge: true });
        
        function listen() {
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(doc(db, 'trip-planner-v1', tripId), snap => {
                if (snap.exists()) {
                    data = snap.data();
                    data.users = data.users || {};
                    data.locations = data.locations || [];
                    data.packing = data.packing || [];
                    data.itinerary = data.itinerary || {};
                    
                    if (user.id && !data.users[user.id]) {
                        data.users[user.id] = { name: user.name, dates: [] };
                        sync();
                    }
                } else {
                    data = { users: {}, locations: [], packing: [
                        { id: 1, text: "Book travel", checked: false },
                        { id: 2, text: "Book hotels", checked: false }
                    ], itinerary: {} };
                    data.users[user.id] = { name: user.name, dates: [] };
                    sync();
                }
                render();
            });
        }

        // Helpers
        const today = () => new Date().toISOString().split('T')[0];
        const dateStr = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const formatDate = (s) => new Date(s+'T12:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        function getDateCounts() {
            const counts = {};
            Object.values(data.users).forEach(u => (u.dates || []).forEach(d => counts[d] = (counts[d] || 0) + 1));
            return counts;
        }
        
        function getBestDates() {
            const counts = getDateCounts();
            const max = Math.max(0, ...Object.values(counts));
            return max > 1 ? Object.keys(counts).filter(d => counts[d] === max).sort() : [];
        }

        function getTopLocation() {
            if (!data.locations.length) return null;
            const sorted = [...data.locations].sort((a, b) => b.votes.length - a.votes.length);
            if (sorted[0].votes.length === 0) return null;
            return sorted[0];
        }

        function saveRecent() {
            let recent = JSON.parse(localStorage.getItem('my_trips') || '[]');
            recent = recent.filter(t => t.id !== tripId);
            const name = data.name || (getTopLocation()?.name ? `Trip to ${getTopLocation().name}` : `Trip ${tripId.slice(0,4)}`);
            recent.unshift({ id: tripId, name });
            localStorage.setItem('my_trips', JSON.stringify(recent.slice(0, 5)));
        }

        // Render functions
        function render() {
            if (!tripId) return renderLanding();
            if (!user.name) return renderLogin();
            saveRecent();
            renderApp();
        }

        function renderLanding() {
            const recent = JSON.parse(localStorage.getItem('my_trips') || '[]');
            $('app').innerHTML = `
                <div class="container" style="padding-top: 4rem;">
                    <div class="text-center mb-4">
                        <img src="logo.png" alt="" style="width: 80px; margin: 0 auto 1rem;">
                        <h1 style="font-size: 2rem; margin-bottom: 2rem;">Trip Helper</h1>
                        <button class="btn btn-primary" style="width: 100%;" onclick="createTrip()">Start New Trip</button>
                    </div>
                    ${recent.length ? `
                        <div class="card-header text-center" style="margin-top: 2rem;">Recent Trips</div>
                        ${recent.map(t => `
                            <div class="list-item" onclick="location.href='?token=${t.id}'" style="cursor: pointer;">
                                <span class="flex-1 font-bold">${t.name}</span>
                                <span class="text-muted">‚Üí</span>
                            </div>
                        `).join('')}
                    ` : ''}
                </div>
            `;
        }

        function renderLogin() {
            $('app').innerHTML = `
                <div class="modal-bg">
                    <div class="modal">
                        <h2>üëã Who are you?</h2>
                        <input type="text" id="name-input" placeholder="Your name" autofocus>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="joinTrip()">Join Trip</button>
                        <button class="btn btn-ghost" style="width: 100%; margin-top: 0.5rem;" onclick="location.href=location.pathname">‚Üê Back</button>
                    </div>
                </div>
            `;
            $('name-input').onkeypress = e => e.key === 'Enter' && joinTrip();
            $('name-input').focus();
        }

        function renderApp() {
            const topLoc = getTopLocation();
            const bestDates = getBestDates();
            const members = Object.values(data.users);
            
            $('app').innerHTML = `
                <div class="container">
                    <!-- Header -->
                    <header style="padding: 0; margin-bottom: 1rem;">
                        <div class="flex items-center gap-2" onclick="copyLink()" style="cursor: pointer;">
                            <img src="logo.png" style="width: 32px;">
                            <h1>${data.name || 'Trip Helper'}</h1>
                            <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); editName()">‚úé</button>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-ghost" onclick="location.href=location.pathname">History</button>
                            <button class="btn btn-sm btn-ghost" onclick="switchUser()">${user.name} ‚ñº</button>
                        </div>
                    </header>

                    <!-- Finalized info -->
                    ${data.finalizedDestination || data.finalizedDates ? `
                        <div class="banner">
                            ${data.finalizedDestination ? `üìç ${data.finalizedDestination}` : ''}
                            ${data.finalizedDestination && data.finalizedDates ? ' ¬∑ ' : ''}
                            ${data.finalizedDates ? `üìÖ ${data.finalizedDates.map(formatDate).join(', ')}` : ''}
                        </div>
                    ` : ''}

                    <!-- Tabs -->
                    <div class="tabs">
                        <button class="tab ${tab === 'plan' ? 'active' : ''}" onclick="setTab('plan')">Plan</button>
                        <button class="tab ${tab === 'vote' ? 'active' : ''}" onclick="setTab('vote')">Vote</button>
                        <button class="tab ${tab === 'itin' ? 'active' : ''}" onclick="setTab('itin')">Itinerary</button>
                        <button class="tab ${tab === 'pack' ? 'active' : ''}" onclick="setTab('pack')">Checklist</button>
                    </div>

                    <!-- Plan Tab -->
                    <div class="${tab !== 'plan' ? 'hidden' : ''}">
                        <!-- Destination -->
                        <div class="card">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="card-header">Destination</div>
                                    <div style="font-size: 1.5rem; font-weight: 700;">
                                        ${topLoc ? topLoc.name : 'Vote pending'}
                                    </div>
                                </div>
                                ${topLoc && !data.finalizedDestination ? `
                                    <button class="btn btn-sm" style="background: rgba(251,191,36,0.2); color: #fbbf24;" onclick="lockDest()">üîí Lock</button>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Members -->
                        <div class="card">
                            <div class="flex justify-between items-center mb-2">
                                <div class="card-header">üë• Squad (${members.length})</div>
                                <button class="btn btn-sm btn-ghost" onclick="copyLink()">Invite +</button>
                            </div>
                            <div class="flex gap-2" style="flex-wrap: wrap;">
                                ${members.map(u => `<span class="badge">‚óè ${u.name}</span>`).join('')}
                            </div>
                        </div>

                        <!-- Calendar -->
                        <div class="card">
                            <div class="flex justify-between items-center mb-2">
                                <div class="card-header">üìÖ Availability</div>
                                <div class="flex gap-2 text-xs text-muted">
                                    <span>üü¢ You</span>
                                    <span>üîµ Others</span>
                                    <span>üü° Best</span>
                                </div>
                            </div>
                            ${renderCalendar()}
                            <div class="flex justify-between items-center" style="margin-top: 0.75rem;">
                                <span class="text-sm" style="color: #fbbf24;">
                                    ${bestDates.length ? `üî• ${bestDates.length} best dates` : 'Select dates to match!'}
                                </span>
                                ${bestDates.length && !data.finalizedDates ? `
                                    <button class="btn btn-sm" style="background: rgba(251,191,36,0.2); color: #fbbf24;" onclick="lockDates()">üîí Lock</button>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Who's available -->
                        <div class="card">
                            <div class="card-header mb-2">Availability by Person</div>
                            ${members.map(u => `
                                <div class="list-item">
                                    <span class="font-bold text-sm">${u.name}</span>
                                    <span class="flex-1 text-xs text-muted" style="text-align: right;">
                                        ${(u.dates || []).length ? (u.dates || []).sort().map(formatDate).join(', ') : 'No dates'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Vote Tab -->
                    <div class="${tab !== 'vote' ? 'hidden' : ''}">
                        <div class="card">
                            <div style="position: relative;">
                                <input type="text" id="search-input" placeholder="Search city..." oninput="searchCity(this.value)">
                                <div id="suggestions" class="suggestions hidden"></div>
                            </div>
                        </div>
                        
                        ${data.locations.length === 0 ? `
                            <div class="card text-center text-muted">No locations yet. Search above!</div>
                        ` : ''}
                        
                        ${[...data.locations].sort((a,b) => b.votes.length - a.votes.length).map(loc => {
                            const voted = loc.votes.includes(user.id);
                            return `
                                <div class="card vote-card ${voted ? 'voted' : ''}">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="font-bold">${loc.name}</div>
                                            <span class="badge">${loc.votes.length} votes</span>
                                            ${voted ? '<span class="text-xs" style="color: #3b82f6; margin-left: 0.5rem;">YOU</span>' : ''}
                                        </div>
                                        <div class="flex gap-2">
                                            <button class="btn btn-sm ${voted ? 'btn-primary' : 'btn-ghost'}" onclick="toggleVote(${loc.id})">
                                                ${voted ? '‚úì' : '+'}
                                            </button>
                                            <button class="btn btn-sm btn-ghost" onclick="deleteLoc(${loc.id})">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Itinerary Tab -->
                    <div class="${tab !== 'itin' ? 'hidden' : ''}">
                        ${renderItinerary()}
                    </div>

                    <!-- Checklist Tab -->
                    <div class="${tab !== 'pack' ? 'hidden' : ''}">
                        <div class="card">
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="pack-input" placeholder="Add item...">
                                <button class="btn btn-primary" onclick="addPackItem()">+</button>
                            </div>
                            ${(data.packing || []).map(item => `
                                <div class="list-item" onclick="togglePack(${item.id})">
                                    <span style="opacity: ${item.checked ? 0.5 : 1}; ${item.checked ? 'text-decoration: line-through' : ''}">
                                        ${item.checked ? '‚òë' : '‚òê'} ${item.text}
                                    </span>
                                    <span class="flex-1"></span>
                                    <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); deletePack(${item.id})">‚úï</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCalendar() {
            const year = calMonth.getFullYear();
            const month = calMonth.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthName = calMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const counts = getDateCounts();
            const maxCount = Math.max(0, ...Object.values(counts));
            const myDates = data.users[user.id]?.dates || [];
            const todayStr = today();
            
            let html = `
                <div class="flex justify-between items-center mb-2">
                    <button class="btn btn-sm btn-ghost" onclick="changeMonth(-1)">‚Üê</button>
                    <span class="font-bold">${monthName}</span>
                    <button class="btn btn-sm btn-ghost" onclick="changeMonth(1)">‚Üí</button>
                </div>
                <div class="cal-grid">
                    ${['S','M','T','W','T','F','S'].map(d => `<div class="cal-day header">${d}</div>`).join('')}
                    ${'<div></div>'.repeat(firstDay)}
            `;
            
            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(year, month, i);
                const ds = dateStr(d);
                const isPast = ds < todayStr;
                const isMine = myDates.includes(ds);
                const count = counts[ds] || 0;
                const isBest = count === maxCount && maxCount > 1;
                
                let cls = 'cal-day';
                if (isPast) cls += ' past';
                else if (isBest) cls += ' best';
                else if (isMine) cls += ' mine';
                else if (count > 0) cls += ' others';
                
                html += `<div class="${cls}" onclick="toggleDate('${ds}')">${i}</div>`;
            }
            
            return html + '</div>';
        }

        function renderItinerary() {
            const dates = Object.keys(data.itinerary || {}).sort();
            const bestDates = data.finalizedDates || getBestDates();
            
            if (dates.length === 0) {
                return `
                    <div class="card text-center">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÖ</div>
                        <p class="text-muted mb-4">No itinerary yet</p>
                        ${bestDates.length ? `
                            <button class="btn btn-primary" onclick="createItinerary()">‚ú® Create from best dates</button>
                        ` : '<p class="text-sm text-muted">Lock dates first to start planning!</p>'}
                    </div>
                `;
            }
            
            return dates.map(date => {
                const events = (data.itinerary[date] || []).sort((a,b) => a.time.localeCompare(b.time));
                const dObj = new Date(date + 'T12:00');
                return `
                    <div class="card" style="padding: 0;">
                        <div class="flex justify-between items-center" style="padding: 0.75rem; background: rgba(255,255,255,0.05);">
                            <div>
                                <div class="card-header" style="color: #fbbf24;">${dObj.toLocaleDateString('en-US', { weekday: 'long' })}</div>
                                <div class="font-bold">${dObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</div>
                            </div>
                            <button class="btn btn-sm btn-ghost" onclick="addEvent('${date}')">+ Add</button>
                        </div>
                        <div style="padding: 0.5rem;">
                            ${events.length === 0 ? '<div class="text-center text-muted text-sm" style="padding: 1rem;">No events</div>' : ''}
                            ${events.map(e => `
                                <div class="list-item" onclick="editEvent('${date}', '${e.id}')">
                                    <span class="text-sm font-bold" style="width: 3rem;">${e.time}</span>
                                    <span class="flex-1">${e.title}</span>
                                    ${e.cost ? `<span class="text-xs" style="color: #10b981;">‚Ç¨${e.cost}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Event handlers
        window.createTrip = async () => {
            await signInAnonymously(getAuth(app));
            tripId = doc(db, 'x').id;
            history.pushState({}, '', `?token=${tripId}`);
            render();
        };

        window.joinTrip = () => {
            const name = $('name-input').value.trim();
            if (!name) return;
            user = { id: name.toLowerCase().replace(/[^a-z0-9]/g, '_'), name };
            localStorage.setItem('trip_user_name', name);
            listen();
        };

        window.setTab = (t) => { tab = t; render(); };
        window.changeMonth = (d) => { calMonth.setMonth(calMonth.getMonth() + d); render(); };
        
        window.toggleDate = (ds) => {
            if (ds < today()) return;
            const u = data.users[user.id];
            if (!u) return;
            u.dates = u.dates || [];
            const idx = u.dates.indexOf(ds);
            if (idx >= 0) u.dates.splice(idx, 1);
            else u.dates.push(ds);
            sync();
        };

        window.copyLink = () => {
            navigator.clipboard.writeText(location.href);
            alert('Link copied!');
        };

        window.editName = () => {
            const name = prompt('Trip name:', data.name || '');
            if (name !== null) { data.name = name.trim(); sync(); }
        };

        window.switchUser = () => {
            if (confirm('Switch user?')) {
                localStorage.removeItem('trip_user_name');
                location.reload();
            }
        };

        window.lockDest = () => {
            const top = getTopLocation();
            if (top) { data.finalizedDestination = top.name; sync(); }
        };

        window.lockDates = () => {
            const best = getBestDates();
            if (best.length) {
                data.finalizedDates = best;
                best.forEach(d => { if (!data.itinerary[d]) data.itinerary[d] = []; });
                sync();
            }
        };

        // Voting
        let searchTimeout;
        window.searchCity = (q) => {
            clearTimeout(searchTimeout);
            if (q.length < 3) { $('suggestions').classList.add('hidden'); return; }
            searchTimeout = setTimeout(async () => {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
                const places = await res.json();
                if (places.length) {
                    $('suggestions').innerHTML = places.slice(0, 5).map(p => `
                        <div class="suggestion" onclick="addLocation('${p.display_name.split(',')[0].replace(/'/g, "\\'")}', ${p.lat}, ${p.lon})">
                            <div class="font-bold">${p.display_name.split(',')[0]}</div>
                            <div class="text-xs text-muted">${p.display_name}</div>
                        </div>
                    `).join('');
                    $('suggestions').classList.remove('hidden');
                }
            }, 300);
        };

        window.addLocation = (name, lat, lon) => {
            if (!data.locations.find(l => l.name === name)) {
                data.locations.push({ id: Date.now(), name, coords: { lat, lon }, votes: [user.id] });
                sync();
            }
            $('search-input').value = '';
            $('suggestions').classList.add('hidden');
        };

        window.toggleVote = (id) => {
            const loc = data.locations.find(l => l.id === id);
            if (!loc) return;
            const idx = loc.votes.indexOf(user.id);
            if (idx >= 0) loc.votes.splice(idx, 1);
            else loc.votes.push(user.id);
            sync();
        };

        window.deleteLoc = (id) => {
            if (confirm('Delete location?')) {
                data.locations = data.locations.filter(l => l.id !== id);
                sync();
            }
        };

        // Checklist
        window.addPackItem = () => {
            const input = $('pack-input');
            if (input.value.trim()) {
                data.packing.push({ id: Date.now(), text: input.value.trim(), checked: false });
                sync();
                input.value = '';
            }
        };

        window.togglePack = (id) => {
            const item = data.packing.find(i => i.id === id);
            if (item) { item.checked = !item.checked; sync(); }
        };

        window.deletePack = (id) => {
            data.packing = data.packing.filter(i => i.id !== id);
            sync();
        };

        // Itinerary
        window.createItinerary = () => {
            const dates = data.finalizedDates || getBestDates();
            dates.forEach(d => { if (!data.itinerary[d]) data.itinerary[d] = []; });
            sync();
        };

        window.addEvent = (date) => showEventModal(date);
        window.editEvent = (date, id) => showEventModal(date, id);

        function showEventModal(date, eventId = null) {
            const event = eventId ? data.itinerary[date]?.find(e => e.id == eventId) : null;
            const dates = Object.keys(data.itinerary).sort();
            
            const modal = document.createElement('div');
            modal.className = 'modal-bg';
            modal.innerHTML = `
                <div class="modal">
                    <h2>${event ? 'Edit Event' : 'Add Event'}</h2>
                    <select id="ev-date" class="mb-2">
                        ${dates.map(d => `<option value="${d}" ${d === date ? 'selected' : ''}>${formatDate(d)}</option>`).join('')}
                    </select>
                    <input type="text" id="ev-title" placeholder="Activity" class="mb-2" value="${event?.title || ''}">
                    <div class="flex gap-2 mb-4">
                        <input type="time" id="ev-time" value="${event?.time || '12:00'}">
                        <input type="number" id="ev-cost" placeholder="Cost ‚Ç¨" value="${event?.cost || ''}">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="saveEvent('${date}', ${eventId || 'null'})">Save</button>
                    ${event ? `<button class="btn btn-danger" style="width: 100%; margin-top: 0.5rem;" onclick="deleteEvent('${date}', ${eventId})">Delete</button>` : ''}
                    <button class="btn btn-ghost" style="width: 100%; margin-top: 0.5rem;" onclick="this.closest('.modal-bg').remove()">Cancel</button>
                </div>
            `;
            document.body.appendChild(modal);
            $('ev-title').focus();
        }

        window.saveEvent = (origDate, eventId) => {
            const newDate = $('ev-date').value;
            const title = $('ev-title').value.trim();
            const time = $('ev-time').value;
            const cost = $('ev-cost').value;
            
            if (!title || !time) return;
            
            if (eventId) {
                data.itinerary[origDate] = data.itinerary[origDate].filter(e => e.id != eventId);
            }
            
            if (!data.itinerary[newDate]) data.itinerary[newDate] = [];
            data.itinerary[newDate].push({ id: eventId || Date.now(), title, time, cost });
            
            sync();
            document.querySelector('.modal-bg').remove();
        };

        window.deleteEvent = (date, id) => {
            data.itinerary[date] = data.itinerary[date].filter(e => e.id != id);
            sync();
            document.querySelector('.modal-bg').remove();
        };

        // Close suggestions on outside click
        document.addEventListener('click', e => {
            if (!e.target.closest('#search-input') && !e.target.closest('#suggestions')) {
                $('suggestions')?.classList.add('hidden');
            }
        });

        // Init
        (async () => {
            await signInAnonymously(getAuth(app));
            if (tripId && user.name) {
                user.id = user.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                listen();
            } else {
                render();
            }
        })();

        // Service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }
    </script>
</body>
</html>
