<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>White Noise</title>
    <meta name="theme-color" content="#1a1a1a">
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/white_noise/manifest.json">
    <link rel="stylesheet" href="/shared/nav.css">
    <style>
        * { box-sizing: border-box; }
        body {
            background: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            font-family: system-ui, sans-serif;
        }
        #btn {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: none;
            background: #333;
            color: #fff;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        #btn:hover { transform: scale(1.05); }
        #btn.playing {
            background: #e74c3c;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); }
            50% { box-shadow: 0 0 0 20px rgba(231,76,60,0); }
        }
        .types {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        .types button {
            background: transparent;
            border: 2px solid #444;
            color: #888;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .types button:hover { border-color: #666; color: #aaa; }
        .types button.active { border-color: #fff; color: #fff; }
        .status {
            margin-top: 1.5rem;
            font-size: 0.8rem;
            color: #666;
            min-height: 1.2em;
        }
    </style>
</head>
<body>
    <button id="btn">â–¶</button>
    <div class="types">
        <button data-type="brown" class="active">Deep</button>
        <button data-type="pink">Balanced</button>
        <button data-type="white">Bright</button>
    </div>
    <div class="status"></div>

    <script>
        const btn = document.getElementById('btn');
        const typeButtons = document.querySelectorAll('.types button');
        const status = document.querySelector('.status');

        let ctx, processor, playing = false, wakeLock = null;
        let type = 'brown';

        // Noise state (brown noise needs memory)
        let lastBrown = 0;
        let pinkB = [0, 0, 0, 0, 0, 0, 0];

        function noise() {
            const w = Math.random() * 2 - 1;
            if (type === 'white') return w * 0.15;
            if (type === 'pink') {
                pinkB[0] = 0.99886 * pinkB[0] + w * 0.0555179;
                pinkB[1] = 0.99332 * pinkB[1] + w * 0.0750759;
                pinkB[2] = 0.96900 * pinkB[2] + w * 0.1538520;
                pinkB[3] = 0.86650 * pinkB[3] + w * 0.3104856;
                pinkB[4] = 0.55000 * pinkB[4] + w * 0.5329522;
                pinkB[5] = -0.7616 * pinkB[5] - w * 0.0168980;
                const out = (pinkB[0] + pinkB[1] + pinkB[2] + pinkB[3] + pinkB[4] + pinkB[5] + pinkB[6] + w * 0.5362) * 0.11;
                pinkB[6] = w * 0.115926;
                return out * 0.5;
            }
            // brown
            lastBrown = (lastBrown + w * 0.02) / 1.02;
            return lastBrown * 3.5;
        }

        async function start() {
            if (!ctx) {
                ctx = new (window.AudioContext || window.webkitAudioContext)();
                processor = ctx.createScriptProcessor(4096, 0, 1);
                processor.onaudioprocess = e => {
                    const out = e.outputBuffer.getChannelData(0);
                    for (let i = 0; i < out.length; i++) out[i] = noise();
                };
            }
            if (ctx.state === 'suspended') await ctx.resume();
            processor.connect(ctx.destination);
            playing = true;
            btn.textContent = 'â¸';
            btn.classList.add('playing');
            await acquireWakeLock();
        }

        function stop() {
            if (processor) processor.disconnect();
            playing = false;
            btn.textContent = 'â–¶';
            btn.classList.remove('playing');
            releaseWakeLock();
        }

        async function acquireWakeLock() {
            if (!('wakeLock' in navigator)) return;
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                status.textContent = 'ðŸ”’ Screen lock prevented';
                wakeLock.addEventListener('release', () => {
                    status.textContent = '';
                    if (playing) acquireWakeLock(); // Re-acquire if still playing
                });
            } catch (e) {
                status.textContent = '';
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
            status.textContent = '';
        }

        // Re-acquire wake lock and resume audio when page becomes visible
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && playing) {
                acquireWakeLock();
                if (ctx?.state === 'suspended') ctx.resume();
            }
        });

        // Keep audio alive on mobile - ping audio context periodically
        setInterval(() => {
            if (playing && ctx?.state === 'suspended') ctx.resume();
        }, 1000);

        btn.onclick = () => playing ? stop() : start();

        typeButtons.forEach(b => b.onclick = () => {
            type = b.dataset.type;
            lastBrown = 0;
            pinkB = [0, 0, 0, 0, 0, 0, 0];
            typeButtons.forEach(x => x.classList.toggle('active', x === b));
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/white_noise/sw.js');
        }
    </script>
    <script src="/shared/nav.js"></script>
</body>
</html>
